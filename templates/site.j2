# reverse-proxy {{ item.server.name }} to {{ item.upstream.name }}

upstream {{ item.upstream.name }} {
	server {{ item.upstream.address }}:{{ item.upstream.port }} fail_timeout={{ item.upstream.timeout }};
}

server {
	server_name         {{ item.server.name }};
{% if item.server.tls %}
	listen              {{ item.server.port|default(443) }} ssl{{ ' default_server' if item.default else ''}};
	ssl_protocols       TLSv1 TLSv1.1 TLSv1.2;
	ssl_certificate     /etc/ssl/certs/{{ item.server.name }}.crt;
	ssl_certificate_key /etc/ssl/private/{{ item.server.name }}.key;
{% else %}
	listen              {{ item.server.port|default(80) }}{{ ' default_server' if item.default else ''}};
{% endif %}
	location / {
		proxy_set_header  Host $host;
		proxy_set_header  X-Real-IP $remote_addr;
		proxy_set_header  X-Forwarded-Proto https;
		proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_pass        {{ item.upstream.protocol }}://{{ item.upstream.name }};
		proxy_redirect    default;
	}
}
